<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N1HS7C9R8N"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-N1HS7C9R8N');</script>
    <title>Admin — Officially Human Art</title>
    <link rel="stylesheet" href="/fonts/fonts.css">
    <link rel="icon" type="image/svg+xml" href="/fingerprint-favicon.svg">
    <style>
        :root {
            --navy: #2a2520;
            --navy-light: #3d3630;
            --navy-dark: #1a1510;
            --cream: #f5f0e8;
            --cream-dark: #ebe5da;
            --gold: #3d3427;
            --gold-light: #4a4035;
            --gold-pale: #f0e6d2;
            --ink: #1a1a1a;
            --ink-light: #555555;
            --ink-faint: #888888;
            --success: #276749;
            --error: #c53030;
            --bronze: #c4935a;
            --silver: #9ca3af;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--cream);
            color: var(--ink);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        .container { max-width: 960px; margin: 0 auto; padding: 0 2rem; }
        header {
            padding: 1rem 0;
            background: rgba(245, 240, 232, 0.92);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(26, 26, 26, 0.06);
        }
        .header-inner { display: flex; justify-content: space-between; align-items: center; max-width: 960px; margin: 0 auto; padding: 0 2rem; }
        .logo { font-family: 'Inter', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--navy); text-decoration: none; }
        .logo span { color: var(--gold); }
        main { padding: 2rem 0 4rem; }
        h1 { font-family: 'Fraunces', serif; font-size: 2rem; font-weight: 700; color: var(--navy); margin-bottom: 1.5rem; }
        h2 { font-family: 'Fraunces', serif; font-size: 1.4rem; font-weight: 600; color: var(--navy); margin: 2rem 0 1rem; }

        /* Login form */
        #login-section { max-width: 400px; margin: 4rem auto; text-align: center; }
        #login-section input {
            width: 100%; padding: 0.7rem 1rem; border: 1.5px solid rgba(26,26,26,0.18);
            border-radius: 6px; font-family: inherit; font-size: 0.9rem; margin-bottom: 1rem;
            background: var(--cream);
        }
        .btn {
            padding: 0.6rem 1.5rem; border: none; border-radius: 6px;
            font-family: inherit; font-size: 0.88rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-navy { background: var(--navy); color: #f5f0e8; }
        .btn-navy:hover { background: var(--navy-light); }
        .btn-error { background: var(--error); color: #fff; }
        .btn-error:hover { opacity: 0.9; }
        .btn-sm { padding: 0.35rem 0.85rem; font-size: 0.8rem; }
        .btn-outline { background: transparent; border: 1px solid rgba(26,26,26,0.2); color: var(--ink-light); }

        /* Stats cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card {
            background: #fff; border-radius: 10px; padding: 1.25rem;
            border: 1px solid rgba(26,26,26,0.08);
            text-align: center;
        }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--navy); }
        .stat-label { font-size: 0.78rem; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.06em; }

        /* Reports table */
        .report-card {
            background: #fff; border-radius: 10px; padding: 1.25rem;
            border: 1px solid rgba(26,26,26,0.08); margin-bottom: 1rem;
        }
        .report-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; }
        .report-meta { font-size: 0.82rem; color: var(--ink-faint); margin-top: 0.5rem; }
        .report-reason { margin-top: 0.75rem; font-size: 0.9rem; color: var(--ink-light); background: var(--cream-dark); padding: 0.75rem; border-radius: 6px; }
        .report-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .badge {
            display: inline-block; padding: 0.15rem 0.55rem; border-radius: 100px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-resolved { background: #d1fae5; color: #065f46; }
        .badge-dismissed { background: #e5e7eb; color: #4b5563; }
        .badge-copyright { background: #fce7f3; color: #9d174d; }

        #admin-panel { display: none; }
        .error-msg { color: var(--error); font-size: 0.88rem; margin-top: 0.5rem; }
        .empty-msg { text-align: center; padding: 2rem; color: var(--ink-faint); font-size: 0.9rem; }

        /* Tab navigation */
        .admin-tabs { display: flex; gap: 0; border-bottom: 2px solid rgba(26,26,26,0.1); margin-bottom: 1.5rem; }
        .tab-btn {
            padding: 0.6rem 1.25rem; border: none; background: transparent;
            font-family: inherit; font-size: 0.9rem; font-weight: 600;
            color: var(--ink-faint); cursor: pointer;
            border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--ink-light); }
        .tab-btn.active { color: var(--navy); border-bottom-color: var(--navy); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Search input */
        .search-input {
            width: 100%; max-width: 360px; padding: 0.55rem 1rem;
            border: 1.5px solid rgba(26,26,26,0.14); border-radius: 6px;
            font-family: inherit; font-size: 0.88rem; background: #fff; margin-bottom: 1rem;
        }
        .search-input:focus { outline: none; border-color: var(--navy); }

        /* List rows */
        .list-row {
            background: #fff; border-radius: 10px; padding: 1rem 1.25rem;
            border: 1px solid rgba(26,26,26,0.08); margin-bottom: 0.5rem;
            display: flex; justify-content: space-between; align-items: center;
            gap: 1rem; cursor: pointer; transition: border-color 0.15s;
        }
        .list-row:hover { border-color: rgba(26,26,26,0.2); }
        .list-row-info { flex: 1; min-width: 0; }
        .list-row-info strong { color: var(--navy); }
        .list-row-meta { font-size: 0.8rem; color: var(--ink-faint); margin-top: 0.2rem; }
        .list-row-actions { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }

        /* Detail panel */
        .detail-panel {
            background: #fff; border-radius: 10px; padding: 1.5rem;
            border: 1px solid rgba(26,26,26,0.08); margin-bottom: 1.5rem;
        }
        .detail-panel h3 { font-family: 'Fraunces', serif; font-size: 1.2rem; font-weight: 600; color: var(--navy); margin-bottom: 0.75rem; }
        .detail-grid { display: grid; grid-template-columns: 140px 1fr; gap: 0.4rem 1rem; font-size: 0.88rem; }
        .detail-label { color: var(--ink-faint); font-weight: 600; }
        .detail-value { color: var(--ink); word-break: break-word; }
        .detail-back { background: none; border: none; color: var(--ink-faint); cursor: pointer; font-family: inherit; font-size: 0.85rem; padding: 0; margin-bottom: 1rem; }
        .detail-back:hover { color: var(--ink); }

        /* Additional badges */
        .badge-banned { background: #fee2e2; color: #991b1b; }
        .badge-verified { background: #d1fae5; color: #065f46; }
        .badge-revoked { background: #fee2e2; color: #991b1b; }
        .badge-free { background: #e5e7eb; color: #4b5563; }
        .badge-creator { background: #dbeafe; color: #1e40af; }
        .badge-gold { background: #fef3c7; color: #92400e; }
        .badge-silver { background: #f3f4f6; color: #4b5563; }
        .badge-bronze { background: #fed7aa; color: #9a3412; }
        .filter-btn.active, .cert-filter-btn.active { background: var(--navy); color: var(--cream); border-color: var(--navy); }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <a href="/" class="logo" style="display:flex;align-items:center;gap:12px;text-decoration:none;font-family:'Inter',sans-serif;">
    <svg viewBox="0 0 70 85" fill="none" stroke="currentColor" stroke-width="1.2" xmlns="http://www.w3.org/2000/svg" style="width:36px;height:44px;color:#1a1a1a;">
        <path d="M35 5 C15 5 5 22 5 42 C5 62 15 80 35 80" stroke-linecap="round"/>
        <path d="M35 12 C20 12 12 26 12 42 C12 58 20 72 35 72 C50 72 58 58 58 42" stroke-linecap="round"/>
        <path d="M35 19 C24 19 18 30 18 42 C18 54 24 65 35 65 C46 65 52 54 52 42 C52 30 46 19 35 19" stroke-linecap="round"/>
        <path d="M35 26 C28 26 24 33 24 42 C24 51 28 58 35 58 C42 58 46 51 46 42" stroke-linecap="round"/>
        <path d="M35 33 C31 33 29 37 29 42 C29 47 31 51 35 51 C39 51 41 47 41 42 C41 37 39 33 35 33" stroke-linecap="round"/>
        <path d="M65 42 C65 22 55 5 35 5" stroke-linecap="round"/>
        <path d="M58 42 C58 26 50 12 35 12" stroke-linecap="round"/>
    </svg>
    <span style="display:flex;flex-direction:column;line-height:1.1;">
        <span style="font-size:14px;"><span style="font-weight:300;color:#666666;">officially</span><span style="font-weight:600;color:#1a1a1a;">human</span></span>
        <span style="font-size:24px;font-weight:700;color:#1a1a1a;margin-top:-2px;">.art</span>
    </span>
</a>
            <span style="font-size:0.85rem;color:var(--ink-faint);">Admin Panel</span>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Login -->
            <div id="login-section">
                <h1>Admin Access</h1>
                <p style="color:var(--ink-faint);margin-bottom:1.5rem;">Enter the admin key to continue.</p>
                <input type="password" id="admin-key-input" placeholder="Admin Key">
                <div id="login-error" class="error-msg" style="display:none;"></div>
                <br>
                <button type="button" class="btn btn-navy" id="admin-login-btn">Sign In</button>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel">
                <h1>Admin Dashboard</h1>

                <!-- Stats -->
                <div class="stats-grid" id="stats-grid"></div>

                <!-- Quick Actions -->
                <div style="margin-bottom:2rem;">
                    <button type="button" class="btn btn-sm btn-outline" id="backup-btn">Run Backup</button>
                    <span id="backup-status" style="margin-left:0.5rem;font-size:0.82rem;color:var(--ink-faint);"></span>
                </div>

                <!-- Tab Navigation -->
                <div class="admin-tabs">
                    <button type="button" class="tab-btn active" data-tab="reports">Reports</button>
                    <button type="button" class="tab-btn" data-tab="users">Users</button>
                    <button type="button" class="tab-btn" data-tab="certificates">Certificates</button>
                </div>

                <!-- Reports Tab -->
                <div class="tab-panel active" id="tab-reports">
                    <div style="margin-bottom:1rem;">
                        <button type="button" class="btn btn-sm btn-outline filter-btn active" data-filter="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline filter-btn" data-filter="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline filter-btn" data-filter="resolved">Resolved</button>
                    </div>
                    <div id="reports-list"></div>
                </div>

                <!-- Users Tab -->
                <div class="tab-panel" id="tab-users">
                    <input type="text" class="search-input" id="users-search" placeholder="Search by name or email...">
                    <div id="users-list"></div>
                    <div id="user-detail" style="display:none;"></div>
                </div>

                <!-- Certificates Tab -->
                <div class="tab-panel" id="tab-certificates">
                    <input type="text" class="search-input" id="certs-search" placeholder="Search by title, artist, or ID...">
                    <div style="margin-bottom:1rem;">
                        <button type="button" class="btn btn-sm btn-outline cert-filter-btn active" data-filter="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline cert-filter-btn" data-filter="verified">Verified</button>
                        <button type="button" class="btn btn-sm btn-outline cert-filter-btn" data-filter="revoked">Revoked</button>
                    </div>
                    <div id="certs-list"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
    (function() {
        'use strict';
        var adminKey = sessionStorage.getItem('oh_admin_key') || '';
        var currentFilter = 'all';

        function $(id) { return document.getElementById(id); }
        function escHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        function apiHeaders() {
            return { 'X-Admin-Key': adminKey, 'Content-Type': 'application/json' };
        }

        function apiFetch(url, opts) {
            opts = opts || {};
            opts.headers = Object.assign(apiHeaders(), opts.headers || {});
            return fetch(url, opts).then(function(r) { return r.json(); });
        }

        // Login
        function tryLogin() {
            var key = $('admin-key-input').value.trim();
            if (!key) return;
            adminKey = key;
            apiFetch('/api/admin/stats')
                .then(function(d) {
                    if (d.success) {
                        sessionStorage.setItem('oh_admin_key', key);
                        $('login-section').style.display = 'none';
                        $('admin-panel').style.display = 'block';
                        loadDashboard();
                    } else {
                        $('login-error').textContent = d.message || 'Invalid admin key';
                        $('login-error').style.display = 'block';
                    }
                })
                .catch(function() {
                    $('login-error').textContent = 'Connection error';
                    $('login-error').style.display = 'block';
                });
        }

        $('admin-login-btn').addEventListener('click', tryLogin);
        $('admin-key-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') tryLogin();
        });

        // Auto-login if key stored
        if (adminKey) {
            apiFetch('/api/admin/stats').then(function(d) {
                if (d.success) {
                    $('login-section').style.display = 'none';
                    $('admin-panel').style.display = 'block';
                    loadDashboard();
                } else {
                    sessionStorage.removeItem('oh_admin_key');
                    adminKey = '';
                }
            }).catch(function() {});
        }

        function loadDashboard() {
            loadStats();
            loadReports();
        }

        function loadStats() {
            apiFetch('/api/admin/stats').then(function(d) {
                if (!d.success) return;
                $('stats-grid').innerHTML =
                    '<div class="stat-card"><div class="stat-value">' + d.artists + '</div><div class="stat-label">Artists</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + d.certificates + '</div><div class="stat-label">Certificates</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + d.pendingReports + '</div><div class="stat-label">Pending Reports</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + d.totalReports + '</div><div class="stat-label">Total Reports</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + (d.tiers.gold || 0) + '</div><div class="stat-label">Gold</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + (d.tiers.silver || 0) + '</div><div class="stat-label">Silver</div></div>' +
                    '<div class="stat-card"><div class="stat-value">' + (d.tiers.bronze || 0) + '</div><div class="stat-label">Bronze</div></div>';
            });
        }

        function loadReports() {
            apiFetch('/api/admin/reports').then(function(d) {
                if (!d.success) return;
                renderReports(d.reports);
            });
        }

        function renderReports(reports) {
            var container = $('reports-list');
            var filtered = reports;
            if (currentFilter !== 'all') {
                filtered = reports.filter(function(r) {
                    if (currentFilter === 'pending') return r.status === 'pending';
                    return r.status !== 'pending';
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-msg">No reports found.</div>';
                return;
            }

            container.innerHTML = filtered.map(function(r) {
                var badgeClass = r.status === 'pending' ? 'badge-pending' : (r.status === 'dismissed' ? 'badge-dismissed' : 'badge-resolved');
                var typeBadge = r.type === 'copyright_takedown' ? ' <span class="badge badge-copyright">Copyright</span>' : '';
                return '<div class="report-card" data-id="' + r.id + '">' +
                    '<div class="report-header">' +
                        '<div>' +
                            '<strong>' + escHtml(r.certTitle) + '</strong> <span style="color:var(--ink-faint);font-size:0.82rem;">(' + escHtml(r.certificateId) + ')</span>' +
                            typeBadge +
                            '<div class="report-meta">By ' + escHtml(r.artistName) + ' &middot; Reported ' + new Date(r.createdAt).toLocaleDateString() +
                            (r.reporterEmail ? ' &middot; ' + escHtml(r.reporterEmail) : '') + '</div>' +
                        '</div>' +
                        '<span class="badge ' + badgeClass + '">' + escHtml(r.status) + '</span>' +
                    '</div>' +
                    '<div class="report-reason">' + escHtml(r.reason) + '</div>' +
                    (r.status === 'pending' ?
                        '<div class="report-actions">' +
                            '<button class="btn btn-sm btn-navy resolve-btn" data-id="' + r.id + '" data-action="upheld">Uphold</button>' +
                            '<button class="btn btn-sm btn-outline resolve-btn" data-id="' + r.id + '" data-action="dismissed">Dismiss</button>' +
                            '<button class="btn btn-sm btn-error revoke-btn" data-cert="' + r.certificateId + '">Revoke Certificate</button>' +
                        '</div>' : (r.resolution ? '<div class="report-meta">Resolution: ' + escHtml(r.resolution) + ' on ' + new Date(r.resolvedAt).toLocaleDateString() + '</div>' : '')) +
                '</div>';
            }).join('');

            // Bind resolve buttons
            container.querySelectorAll('.resolve-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = btn.dataset.id;
                    var action = btn.dataset.action;
                    apiFetch('/api/admin/reports/' + id, {
                        method: 'PUT',
                        body: JSON.stringify({ resolution: action })
                    }).then(function(d) {
                        if (d.success) loadReports();
                    });
                });
            });

            // Bind revoke buttons
            container.querySelectorAll('.revoke-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (!confirm('Revoke certificate ' + btn.dataset.cert + '? This cannot be undone.')) return;
                    apiFetch('/api/admin/certificates/' + btn.dataset.cert + '/revoke', { method: 'PUT' })
                        .then(function(d) {
                            if (d.success) { alert('Certificate revoked.'); loadReports(); loadStats(); }
                        });
                });
            });
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                loadReports();
            });
        });

        // Backup button
        $('backup-btn').addEventListener('click', function() {
            $('backup-status').textContent = 'Running...';
            apiFetch('/api/admin/backup').then(function(d) {
                $('backup-status').textContent = d.success ? 'Backup complete.' : (d.message || 'Failed.');
            }).catch(function() { $('backup-status').textContent = 'Error.'; });
        });

        // ===== Tab Switching =====
        var allUsers = [];
        var allCerts = [];
        var currentCertFilter = 'all';
        var usersLoaded = false;
        var certsLoaded = false;

        document.querySelectorAll('.tab-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
                btn.classList.add('active');
                $('tab-' + btn.dataset.tab).classList.add('active');
                if (btn.dataset.tab === 'users' && !usersLoaded) loadUsers();
                if (btn.dataset.tab === 'certificates' && !certsLoaded) loadCerts();
            });
        });

        // ===== Users Tab =====
        function loadUsers() {
            $('users-list').innerHTML = '<div class="empty-msg">Loading...</div>';
            apiFetch('/api/admin/artists').then(function(d) {
                if (!d.success) return;
                allUsers = d.artists;
                usersLoaded = true;
                renderUsers(allUsers);
            });
        }

        function renderUsers(users) {
            var container = $('users-list');
            $('user-detail').style.display = 'none';
            container.style.display = 'block';

            if (users.length === 0) {
                container.innerHTML = '<div class="empty-msg">No users found.</div>';
                return;
            }

            container.innerHTML = users.map(function(u) {
                var badges = '';
                if (u.banned) badges += ' <span class="badge badge-banned">Banned</span>';
                if (!u.emailVerified) badges += ' <span class="badge badge-dismissed">Unverified</span>';
                var planBadge = u.plan === 'creator'
                    ? '<span class="badge badge-creator">Creator</span>'
                    : '<span class="badge badge-free">Free</span>';

                return '<div class="list-row" data-user-id="' + escHtml(u.id) + '">' +
                    '<div class="list-row-info">' +
                        '<strong>' + escHtml(u.name) + '</strong> ' + planBadge + badges +
                        '<div class="list-row-meta">' + escHtml(u.email) +
                        ' &middot; ' + u.certCount + ' cert' + (u.certCount !== 1 ? 's' : '') +
                        ' &middot; Joined ' + new Date(u.createdAt).toLocaleDateString() +
                        '</div>' +
                    '</div>' +
                    '<div class="list-row-actions">' +
                        (u.banned
                            ? '<button class="btn btn-sm btn-outline unban-btn" data-id="' + escHtml(u.id) + '">Unban</button>'
                            : '<button class="btn btn-sm btn-error ban-btn" data-id="' + escHtml(u.id) + '">Ban</button>') +
                    '</div>' +
                '</div>';
            }).join('');

            // Click row to view detail
            container.querySelectorAll('.list-row').forEach(function(row) {
                row.addEventListener('click', function(e) {
                    if (e.target.closest('.ban-btn') || e.target.closest('.unban-btn')) return;
                    loadUserDetail(row.dataset.userId);
                });
            });

            // Ban buttons
            container.querySelectorAll('.ban-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var reason = prompt('Ban reason (optional):');
                    if (reason === null) return;
                    apiFetch('/api/admin/artists/' + btn.dataset.id + '/ban', {
                        method: 'PUT',
                        body: JSON.stringify({ reason: reason || 'Violation of terms of service' })
                    }).then(function(d) {
                        if (d.success) { alert(d.message); loadUsers(); loadStats(); }
                    });
                });
            });

            // Unban buttons
            container.querySelectorAll('.unban-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!confirm('Unban this artist?')) return;
                    apiFetch('/api/admin/artists/' + btn.dataset.id + '/unban', { method: 'PUT' })
                        .then(function(d) {
                            if (d.success) { alert(d.message); loadUsers(); }
                        });
                });
            });
        }

        // Users search
        $('users-search').addEventListener('input', function() {
            var q = this.value.toLowerCase().trim();
            if (!q) { renderUsers(allUsers); return; }
            var filtered = allUsers.filter(function(u) {
                return u.name.toLowerCase().indexOf(q) !== -1 ||
                       u.email.toLowerCase().indexOf(q) !== -1;
            });
            renderUsers(filtered);
        });

        // User detail view
        function loadUserDetail(artistId) {
            apiFetch('/api/admin/artists/' + artistId).then(function(d) {
                if (!d.success) return;
                var a = d.artist;
                var certs = d.certificates;

                $('users-list').style.display = 'none';
                $('users-search').style.display = 'none';
                var detail = $('user-detail');
                detail.style.display = 'block';

                var badges = '';
                if (a.banned) badges += ' <span class="badge badge-banned">Banned</span>';
                if (a.emailVerified) badges += ' <span class="badge badge-verified">Email Verified</span>';

                var certsHtml = '';
                if (certs.length === 0) {
                    certsHtml = '<div class="empty-msg">No certificates.</div>';
                } else {
                    certsHtml = certs.map(function(c) {
                        var tierBadge = '<span class="badge badge-' + escHtml(c.tier) + '">' + escHtml(c.tierLabel || c.tier) + '</span>';
                        var statusBadge = c.status === 'revoked' ? ' <span class="badge badge-revoked">Revoked</span>' : '';
                        return '<div class="list-row" onclick="window.open(\'/verify.html?code=' + escHtml(c.id) + '\',\'_blank\')">' +
                            '<div class="list-row-info">' +
                                '<strong>' + escHtml(c.title) + '</strong> ' + tierBadge + statusBadge +
                                '<div class="list-row-meta">' + escHtml(c.id) +
                                (c.medium ? ' &middot; ' + escHtml(c.medium) : '') +
                                ' &middot; ' + new Date(c.registeredAt).toLocaleDateString() +
                                '</div>' +
                            '</div>' +
                            '<div class="list-row-actions">' +
                                (c.status !== 'revoked'
                                    ? '<button class="btn btn-sm btn-error revoke-detail-btn" data-cert="' + escHtml(c.id) + '" onclick="event.stopPropagation();">Revoke</button>'
                                    : '') +
                            '</div>' +
                        '</div>';
                    }).join('');
                }

                detail.innerHTML =
                    '<button class="detail-back" id="back-to-users">&larr; Back to users</button>' +
                    '<div class="detail-panel">' +
                        '<h3>' + escHtml(a.name) + badges + '</h3>' +
                        '<div class="detail-grid">' +
                            '<span class="detail-label">Email</span><span class="detail-value">' + escHtml(a.email) + '</span>' +
                            '<span class="detail-label">Plan</span><span class="detail-value">' + escHtml(a.plan) + (a.planStatus !== 'active' ? ' (' + escHtml(a.planStatus) + ')' : '') + '</span>' +
                            '<span class="detail-label">Slug</span><span class="detail-value">' + escHtml(a.slug) + '</span>' +
                            '<span class="detail-label">Location</span><span class="detail-value">' + escHtml(a.location || '—') + '</span>' +
                            '<span class="detail-label">Portfolio</span><span class="detail-value">' + (a.portfolio ? '<a href="' + escHtml(a.portfolio) + '" target="_blank" style="color:var(--navy);">' + escHtml(a.portfolio) + '</a>' : '—') + '</span>' +
                            '<span class="detail-label">Bio</span><span class="detail-value">' + escHtml(a.bio || '—') + '</span>' +
                            '<span class="detail-label">Joined</span><span class="detail-value">' + new Date(a.createdAt).toLocaleDateString() + '</span>' +
                            '<span class="detail-label">Last Login</span><span class="detail-value">' + (a.lastLoginAt ? new Date(a.lastLoginAt).toLocaleDateString() : '—') + '</span>' +
                            '<span class="detail-label">Credits</span><span class="detail-value">' + (a.certificateCredits || 0) + '</span>' +
                            (a.banned ? '<span class="detail-label">Ban Reason</span><span class="detail-value">' + escHtml(a.banReason || '—') + '</span>' : '') +
                        '</div>' +
                        '<div style="margin-top:1rem;">' +
                            (a.banned
                                ? '<button class="btn btn-sm btn-outline" id="detail-unban-btn" data-id="' + escHtml(a.id) + '">Unban</button>'
                                : '<button class="btn btn-sm btn-error" id="detail-ban-btn" data-id="' + escHtml(a.id) + '">Ban</button>') +
                        '</div>' +
                    '</div>' +
                    '<h2 style="margin-top:1rem;">Certificates (' + certs.length + ')</h2>' +
                    certsHtml;

                // Back button
                $('back-to-users').addEventListener('click', function() {
                    detail.style.display = 'none';
                    $('users-list').style.display = 'block';
                    $('users-search').style.display = '';
                });

                // Ban/unban in detail
                var banBtn = document.getElementById('detail-ban-btn');
                if (banBtn) {
                    banBtn.addEventListener('click', function() {
                        var reason = prompt('Ban reason (optional):');
                        if (reason === null) return;
                        apiFetch('/api/admin/artists/' + banBtn.dataset.id + '/ban', {
                            method: 'PUT',
                            body: JSON.stringify({ reason: reason || 'Violation of terms of service' })
                        }).then(function(d) {
                            if (d.success) { alert(d.message); loadUserDetail(artistId); usersLoaded = false; loadStats(); }
                        });
                    });
                }
                var unbanBtn = document.getElementById('detail-unban-btn');
                if (unbanBtn) {
                    unbanBtn.addEventListener('click', function() {
                        if (!confirm('Unban this artist?')) return;
                        apiFetch('/api/admin/artists/' + unbanBtn.dataset.id + '/unban', { method: 'PUT' })
                            .then(function(d) {
                                if (d.success) { alert(d.message); loadUserDetail(artistId); usersLoaded = false; }
                            });
                    });
                }

                // Revoke cert buttons in detail
                detail.querySelectorAll('.revoke-detail-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        if (!confirm('Revoke certificate ' + btn.dataset.cert + '?')) return;
                        apiFetch('/api/admin/certificates/' + btn.dataset.cert + '/revoke', { method: 'PUT' })
                            .then(function(d) {
                                if (d.success) { alert('Revoked.'); loadUserDetail(artistId); loadStats(); }
                            });
                    });
                });
            });
        }

        // ===== Certificates Tab =====
        function loadCerts() {
            $('certs-list').innerHTML = '<div class="empty-msg">Loading...</div>';
            apiFetch('/api/admin/certificates').then(function(d) {
                if (!d.success) return;
                allCerts = d.certificates;
                certsLoaded = true;
                renderCerts();
            });
        }

        function renderCerts() {
            var container = $('certs-list');
            var q = $('certs-search').value.toLowerCase().trim();
            var filtered = allCerts;

            if (currentCertFilter !== 'all') {
                filtered = filtered.filter(function(c) { return c.status === currentCertFilter; });
            }
            if (q) {
                filtered = filtered.filter(function(c) {
                    return c.title.toLowerCase().indexOf(q) !== -1 ||
                           c.artistName.toLowerCase().indexOf(q) !== -1 ||
                           c.id.toLowerCase().indexOf(q) !== -1;
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-msg">No certificates found.</div>';
                return;
            }

            container.innerHTML = filtered.map(function(c) {
                var tierBadge = '<span class="badge badge-' + escHtml(c.tier) + '">' + escHtml(c.tierLabel || c.tier) + '</span>';
                var statusBadge = c.status === 'revoked' ? ' <span class="badge badge-revoked">Revoked</span>' : '';
                return '<div class="list-row" data-cert-id="' + escHtml(c.id) + '">' +
                    '<div class="list-row-info">' +
                        '<strong>' + escHtml(c.title) + '</strong> ' + tierBadge + statusBadge +
                        '<div class="list-row-meta">' + escHtml(c.artistName) +
                        ' &middot; ' + escHtml(c.id) +
                        (c.medium ? ' &middot; ' + escHtml(c.medium) : '') +
                        ' &middot; ' + new Date(c.registeredAt).toLocaleDateString() +
                        (c.reportCount > 0 ? ' &middot; <span style="color:var(--error);">' + c.reportCount + ' report(s)</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="list-row-actions">' +
                        (c.status !== 'revoked'
                            ? '<button class="btn btn-sm btn-error cert-revoke-btn" data-cert="' + escHtml(c.id) + '">Revoke</button>'
                            : '') +
                    '</div>' +
                '</div>';
            }).join('');

            // Click row to open certificate
            container.querySelectorAll('.list-row').forEach(function(row) {
                row.addEventListener('click', function(e) {
                    if (e.target.closest('.cert-revoke-btn')) return;
                    window.open('/verify.html?code=' + row.dataset.certId, '_blank');
                });
            });

            // Revoke buttons
            container.querySelectorAll('.cert-revoke-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!confirm('Revoke certificate ' + btn.dataset.cert + '?')) return;
                    apiFetch('/api/admin/certificates/' + btn.dataset.cert + '/revoke', { method: 'PUT' })
                        .then(function(d) {
                            if (d.success) { alert('Revoked.'); certsLoaded = false; loadCerts(); loadStats(); }
                        });
                });
            });
        }

        // Cert search
        $('certs-search').addEventListener('input', function() { renderCerts(); });

        // Cert status filter
        document.querySelectorAll('.cert-filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.cert-filter-btn').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                currentCertFilter = btn.dataset.filter;
                renderCerts();
            });
        });
    })();
    </script>
</body>
</html>
